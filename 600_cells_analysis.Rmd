---
title: "600 cell analysis"
output: html_notebook
---

```{r Set up environment}
#Define packages for install and/or library loading 
pkg_list_cran <- c('BiocManager', 'dplyr', 'Matrix', 'ggplot2', 'rmarkdown')
pkg_list_bioc <- c('Seurat', 'SingleCellExperiment', 'scater')
pkg_list_all <- c(pkg_list_cran, pkg_list_bioc)

##############################################################

# ONLY RUN THIS SECTION IF INSTALLING PACKAGES FROM SCRATCH #

#Install packages
#lapply(pkg_list_cran, install.packages)
#lapply(pkg_list_bioc, BiocManager::install)
#install.packages('here')

#Save renv session
#renv::snapshot()

##############################################################

#Restore renv session
renv::restore()

# Update all packages - recommended if it's been a while
# since the code was last run
# renv::update()

#Load libraries
lapply(pkg_list_all, library, character.only=TRUE)

#Set seed for random number generation
set.seed(444)

```

```{r Define paths}

#Set top-level directory using the here package
here::i_am("600_cells_analysis/600_cells_analysis.Rmd")
library(here)
here()

#Select experiment - CHANGE THIS EACH TIME
exp <- '310523_PR0979_v2'

#Set paths to save and read Seurat objects
ifelse(!dir.exists(here(exp, "r_objects")), dir.create(here(exp, "r_objects")), "Folder exists already")
data_path <- here(exp, 'r_objects')

#Make and/or set path to save figures
ifelse(!dir.exists(here(exp, "r_figures")), dir.create(here(exp, "r_figures")), "Folder exists already")
fig_path <- here(exp, 'r_figures')
```

```{r Convenience functions}
#ReadParseBio with correct count_matrix name
ReadParseBio_count <- function(data.dir, ...) {
  mtx <- file.path(data.dir, "count_matrix.mtx")
  cells <- file.path(data.dir, "cell_metadata.csv")
  features <- file.path(data.dir, "all_genes.csv")
  return(ReadMtx(
    mtx = mtx,
    cells = cells,
    features = features,
    cell.column = 1,
    feature.column = 2,
    cell.sep = ",",
    feature.sep = ",",
    skip.cell = 1,
    skip.feature = 1,
    mtx.transpose = TRUE
  ))
}

#Save figures
SaveFigure <- function(plots, name, type = "png", width, height, res){
  if(type == "png") {
    png(paste0(fig_path, name, ".", type),
      width = width, height = height, units = "in", res = 200)
  } else {
    pdf(paste0(fig_path, name, ".", type),
      width = width, height = height)
}
print(plots)
dev.off()
}

#Save Seurat objects
SaveObject <- function(object, name){
  saveRDS(object, here(exp, 'r_objects', paste0(name, ".RDS")))
}

#Read Seurat objects
ReadObject <- function(name){
  readRDS(here(exp, 'r_objects', paste0(name, ".RDS")))
}
```

```{r Read in data}
#Load in count matrix
data_dir <- here(exp, 'all-sample', 'DGE_filtered')
counts <- ReadParseBio_count(data_dir)

# Check to see if empty gene names are present, add name if so.
table(rownames(counts) == "")
rownames(counts)[rownames(counts) == ""] <- "unknown"

# Read in cell meta data
cell_meta <- read.csv(here(exp, 'all-sample', 'DGE_filtered', "/cell_metadata.csv"), row.names = 1)

#Create Seurat object
seurat_obj <- CreateSeuratObject(counts = counts, names.field = 0, meta.data = cell_meta)
```

FROM PARSE BIO:
When we create our Seurat object the plate well numbers (column names in the expression matrix) from the experiment will automatically be assigned to the cell identity slot. In other words, the program assumes this how we want to initially classify our cells. In general, we would like to avoid this behavior so there isn't a bias towards a particular cell class when removing outliers.

```{r Well numbers}
# Setting our initial cell class to a single type, this will change after clustering. 
seurat_obj@meta.data$orig.ident <- factor(rep("seurat_obj", nrow(seurat_obj@meta.data)))
Idents(seurat_obj) <- seurat_obj@meta.data$orig.ident

#Save raw Seurat object
SaveObject(seurat_obj, 'raw_seurat_obj')
#seurat_obj <- ReadObject('raw_seurat_obj')

#Save raw SingleCellExperiment object
sce_obj <- as.SingleCellExperiment(seurat_obj)
SaveObject(sce_obj, 'raw_sce_obj')
```

```{r Cell quality control}

```
